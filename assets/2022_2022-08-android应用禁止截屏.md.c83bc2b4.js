import{_ as s,c as a,o as n,a as l}from"./app.7f1206cf.js";const C=JSON.parse('{"title":"2022-08-android应用禁止截屏","description":"","frontmatter":{},"headers":[],"relativePath":"2022/2022-08-android应用禁止截屏.md","lastUpdated":1676736399000}'),p={name:"2022/2022-08-android应用禁止截屏.md"},o=l(`<h1 id="_2022-08-android应用禁止截屏" tabindex="-1">2022-08-android应用禁止截屏 <a class="header-anchor" href="#_2022-08-android应用禁止截屏" aria-hidden="true">#</a></h1><h2 id="_1-需求场景" tabindex="-1">1. 需求场景 <a class="header-anchor" href="#_1-需求场景" aria-hidden="true">#</a></h2><p>使用银行APP的时候发现不能截屏。想看下他的实现原理。</p><h2 id="_2-截屏实现" tabindex="-1">2. 截屏实现 <a class="header-anchor" href="#_2-截屏实现" aria-hidden="true">#</a></h2><h3 id="_2-1-应用内截屏" tabindex="-1">2.1 应用内截屏 <a class="header-anchor" href="#_2-1-应用内截屏" aria-hidden="true">#</a></h3><p>用view或者activity的容器缓存生成图片，实现截屏</p><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 获取需要截取快照的控件</span></span>
<span class="line"><span style="color:#A6ACCD;">View view </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">findViewById</span><span style="color:#A6ACCD;">(R</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">my_view)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 设置控件允许绘制缓存</span></span>
<span class="line"><span style="color:#A6ACCD;">view</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setDrawingCacheEnabled</span><span style="color:#A6ACCD;">(</span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 获取控件的绘制缓存（快照）</span></span>
<span class="line"><span style="color:#A6ACCD;">Bitmap bitmap </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> view</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDrawingCache</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 保存截取的快照</span></span>
<span class="line"><span style="color:#A6ACCD;">bitmap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">compress</span><span style="color:#A6ACCD;">(Bitmap</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">CompressFormat</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PNG</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> fileOutputStream)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * 每个Activity都有一个铺满全屏的顶层View，只需要获取这个View的绘制快照，</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * 就相当于截取了整个Activity的屏幕，这种方式截取部分包括通知栏，但不包括</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * 通知烂上的内容，因为其内容不属于当前的Activity。</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 获取Activity整个窗口最顶层的View</span></span>
<span class="line"><span style="color:#A6ACCD;">View view </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> activity</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getWindow</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDecorView</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 设置控件允许绘制缓存</span></span>
<span class="line"><span style="color:#A6ACCD;">view</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setDrawingCacheEnabled</span><span style="color:#A6ACCD;">(</span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 获取控件的绘制缓存（快照）</span></span>
<span class="line"><span style="color:#A6ACCD;">Bitmap bitmap </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> view</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDrawingCache</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 保存截取的快照</span></span>
<span class="line"><span style="color:#A6ACCD;">bitmap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">compress</span><span style="color:#A6ACCD;">(Bitmap</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">CompressFormat</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PNG</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> fileOutputStream)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><h3 id="_2-2-adb命令截屏" tabindex="-1">2.2 adb命令截屏 <a class="header-anchor" href="#_2-2-adb命令截屏" aria-hidden="true">#</a></h3><p>adb命令截屏需要root</p><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">adb shell screencap </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">p </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">sdcard</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">sreenshot1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">png</span></span>
<span class="line"></span></code></pre></div><h3 id="_2-3-anroid5-0以后通过api截屏" tabindex="-1">2.3 anroid5.0以后通过api截屏 <a class="header-anchor" href="#_2-3-anroid5-0以后通过api截屏" aria-hidden="true">#</a></h3><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (Build</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">VERSION</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SDK_INT </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">21</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">startActivityForResult</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">            ((</span><span style="color:#A6ACCD;">MediaProjectionManager</span><span style="color:#F07178;">) </span><span style="color:#82AAFF;">getSystemService</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">media_projection</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">))</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createScreenCaptureIntent</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">Log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">e</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">TAG</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">版本过低,无法截屏</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#A6ACCD;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">protected </span><span style="color:#89DDFF;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">onActivityResult</span><span style="color:#A6ACCD;">(int requestCode</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> int resultCode</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Intent data) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">super</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onActivityResult</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">requestCode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resultCode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">data</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">requestCode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">data</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#82AAFF;">parseData</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">data</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">private </span><span style="color:#89DDFF;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">parseData</span><span style="color:#A6ACCD;">(Intent data)</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">MediaProjection</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mMediaProjection</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">MediaProjectionManager</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSystemService</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">Context</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MEDIA_PROJECTION_SERVICE</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getMediaProjection</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">Activity</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RESULT_OK</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">data</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">ImageReader</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mImageReader</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ImageReader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newInstance</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">                </span><span style="color:#82AAFF;">getScreenWidth</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                </span><span style="color:#82AAFF;">getScreenHeight</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                </span><span style="color:#A6ACCD;">PixelFormat</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RGBA_8888</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">VirtualDisplay</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mVirtualDisplay</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mMediaProjection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createVirtualDisplay</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">screen-mirror</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#82AAFF;">getScreenWidth</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#82AAFF;">getScreenHeight</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">Resources</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSystem</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDisplayMetrics</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">densityDpi</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">DisplayManager</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">VIRTUAL_DISPLAY_FLAG_AUTO_MIRROR</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">mImageReader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSurface</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">Handler</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">handler</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Handler</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">handler</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">postDelayed</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Runnable</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       @</span><span style="color:#A6ACCD;">Override</span></span>
<span class="line"><span style="color:#F07178;">       public void run</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">           </span><span style="color:#A6ACCD;">Image</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">image</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mImageReader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">acquireLatestImage</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">           </span><span style="color:#676E95;font-style:italic;">// TODO 将image保存到本地即可</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">300</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">mVirtualDisplay</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">release</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">mVirtualDisplay</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="_3-禁止截屏实现" tabindex="-1">3. 禁止截屏实现 <a class="header-anchor" href="#_3-禁止截屏实现" aria-hidden="true">#</a></h2><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">public </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FlagSecureTestActivity</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Activity</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">@</span><span style="color:#A6ACCD;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">onCreate</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">Bundle</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">savedInstanceState</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">super</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onCreate</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">savedInstanceState</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">getWindow</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setFlags</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">LayoutParams</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">FLAG_SECURE</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">LayoutParams</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">FLAG_SECURE</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">setContentView</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">R</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">layout</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">main</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="_4-截屏监听" tabindex="-1">4. 截屏监听 <a class="header-anchor" href="#_4-截屏监听" aria-hidden="true">#</a></h2><p>Android系统并没有提供截屏通知相关的API，需要我们自己利用系统能提供的相关特性变通实现。Android系统有一个媒体数据库，每拍一张照片，或使用系统截屏截取一张图片，都会把这张图片的详细信息加入到这个媒体数据库，并发出内容改变通知，我们可以利用内容观察者（ContentObserver）监听媒体数据库的变化，当数据库有变化时，获取最后插入的一条图片数据，如果该图片符合特定的规则，则认为被截屏了。 需要ContentObserver监听的资源URI:</p><ul><li>MediaStore.Images.Media.INTERNAL_CONTENT_URI</li><li>MediaStore.Images.Media.EXTERNAL_CONTENT_URI</li></ul><p>读取外部存储器资源，需要添加权限: android.permission.READ_EXTERNAL_STORAGE <a href="https://blog.csdn.net/xietansheng/article/details/52692163" target="_blank" rel="noreferrer"></a> 当ContentObserver监听到媒体数据库的数据改变, 在有数据改变时 获取最后插入数据库的一条图片数据, 如果符合以下规则, 则认为截屏了:</p><ul><li>1、时间判断，图片的生成时间在开始监听之后, 并与当前时间相隔10秒内：开始监听后生成的图片才有意义，相隔10秒内说明是刚刚生成的；</li><li>2、尺寸判断，图片的尺寸没有超过屏幕的尺寸：图片尺寸超过屏幕尺寸，一般都不是截屏图片（最近发现某些手机ROM支持滑动截屏，如果需要监听的APP界面支持滑动，需要做适当的调整和处理）；</li><li>3、路径判断，图片路径符合包含特定的关键词：这一点是关键，截屏图片的保存路径通常包含“screenshot”。</li></ul><p>PS： 这些判断是为了增加截屏检测结果的可靠性，防止误报，防止遗漏。其中截屏图片的路径正常Android系统保存的路径格式为：“外部存储器/Pictures/Screenshots/Screenshot_20161001-164643.png”，但Android系统碎片化严重，加上其他第三方截屏APP等，所以路径关键字除了检查是否包含“screenshot”外，还可以适当增加其他关键字，详见最后的监听器完整代码。这种监听截屏的方法也不是100%准确，例如某些被root的机器使用第三方截屏APP自定义保存路径，还比如通过ADB命令在电脑上获取手机屏幕快照均不能监听到，但这也是目前可行性最高的方法，对于绝大多数用户都比较靠谱。 <a href="https://blog.csdn.net/xietansheng/article/details/52692163" target="_blank" rel="noreferrer"></a></p>`,22),e=[o];function t(c,r,y,F,D,i){return n(),a("div",null,e)}const d=s(p,[["render",t]]);export{C as __pageData,d as default};
